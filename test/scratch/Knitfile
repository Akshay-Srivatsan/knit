knit = import("knit")

cc = cli.cc or "gcc"
debug = tobool(cli.debug) or false
lld = tobool(cli.lld) or false

cflags = "-Wall"

if debug then
    cflags = f"$cflags -Og -g -fsanitize=address,undefined"
else
    cflags = f"$cflags -O2"
end

ldflags = ""
if lld then
    ldflags = "-fuse-ld=lld"
end

src = knit.glob("*.c")
obj = knit.extrepl(src, ".c", ".o")
prog = "hello"

date = knit.shell("date")

$ all:V: $prog

$ $prog: $obj
    $cc $cflags $ldflags $input -o $output

$ %.o: %.c
    $cc $cflags -c $input -o $output

$ clean:V:
    rm -f $obj $prog

$ echo-%:VQ:
    echo $(eval(match))
