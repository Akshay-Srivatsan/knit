knit = import("knit")

cc = cli.cc or "gcc"
debug = cli.debug or 0
lld = cli.lld or 0

cflags = "-Wall"

if debug ~= 0 then
    cflags = f"$cflags -Og -g -fsanitize=address,undefined"
else
    cflags = f"$cflags -O2"
end

ldflags = ""
if lld ~= 0 then
    ldflags = "-fuse-ld=lld"
end

src = knit.Glob("*.c")
obj = knit.ExtRepl(src, ".c", ".o")
prog = "hello"

date = knit.Shell("date")

$ all:V: $prog

$ $prog: $obj
    $cc $cflags $ldflags $in -o $out

$ %.o: %.c
    $cc $cflags -c $in -o $out

$ clean:V:
    rm -f $obj $prog

$ echo-%:VQ:
    echo $(eval(match))
