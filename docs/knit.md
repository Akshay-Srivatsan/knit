Note: this documentation is out of date.

# Rules

A rule consists of four parts:

* Targets: a list of values that are generated by this rule.
* Prereqs: a list of values that must be generated before this rule can be
  executed.
* Attributes: a list of flags that customize how this rule is interpreted.
* Recipe: a list of commands that are run to execute the rule.

The syntax for a rule is

```
targets:attributes: prereqs
    recipe
```

If the rule has no attributes, it may be omitted, leaving just `targets: prereqs`.

When a rule is embedded in Lua, it is prefixed with a `$`:

```
$ targets:attributes: prereqs
    recipe
```

Direct rules are rules where the targets and prereqs are explicit names of
values.

## Meta rules

A meta rule is a special rule that describes a generic way to create direct
rules.  The meta rule describes how to match targets and prereqs into a direct
rule.  For example, a `%` meta rule uses `%` to match any sequence of
characters.

Thus the meta rule

```
%.o: %.c
    ...
```

describes that a direct rule

```
foo.o: foo.c
    ...
```

could be created. This direct rule would be created if another rule needed
`foo.o` to be generated.

Meta rules may also specify the match by using regular expressions, if the `R`
attribute is provided. For example:

```
foo-(.*)-(.*).tar.gz:R: $1/$2/foo
    ...
```

could create a direct rule

```
foo-linux-amd64.tar.gz: linux/amd64/foo
    ...
```

## Attributes

Knit supports the following attributes:

* `Q` (quiet): do not print this rule's recipe when executing.
* `R` (regex): this meta rule uses regular expression matching.
* `V` (virtual): the value this rule generates is not a file, just a name.
* `M` (no meta): this rule's targets cannot be matched by meta rules.
* `X` (exclusive): this rule cannot execute in parallel with any other rules.
* `E` (non-stop): this rule does not stop if one of its commands fails.

## Recipes

A recipe is a list of commands to execute. They are executed within the `sh`
shell. Recipes may use variables that will be expanded before the recipe
executes. Variables are written with `$var`, or full Lua expressions can be
written with `$(expr)`. Expressions and variables are evaluated in the global
scope, meaning local variables are not available during this expansion.

Some special variables are available during recipe expansion:

* `input`: a string of rule's prereqs.
* `inputs`: an array of this rule's prereqs.
* `output`: a string of this rule's targets.
* `outputs`: an array of this rule's targets.
* `match`: the value captured with `%` in a meta rule.
* `matches`: a list of matches captured by a regular expression meta rule.

# Knitfiles

A Knitfile is a Lua 5.1 program that may also contain inline rule declarations using the syntax

```
$ targets:attributes: prereqs
    ...
```

This means, for example, that rules can be dynamically created:

```
if condition then
$ targets:attributes: prereqs
    ...
end
```

This rule is only created if the Lua expression `condition` is true.

Knit will search the current directory for a Knitfile called `knitfile` or
`Knitfile`. If one is not found, it will use the Knitfile in
`~/.config/knit/Knitfile.def`, or if that does not exist it will throw an
error.

# Built-in Lua functions

* `import(pkg string) table`: import a built-in package. Currently the only built-in package is `knit`.

* `rule(rule string)`: define a rule. The `$` syntax is shorthand for this function.

* `include(file string)`: include a rule from a file if it exists.

* `tostring(value) string`: convert an arbitrary value to a string.

* `tobool(value)` bool: convert an arbitrary value to a boolean. A nil value
  will return nil, the strings `false`, `off`, or `0` will become false. A
  boolean will not be converted. Anything else will be true.

* `eval(code string): value`: evaluates a Lua expression in the global scope and returns the result.

* `f"..."`, `f(s string) string`: formats a string using `$var` or `$(var)` to
  expand variables. Does not expand expressions.

# The `knit` Lua package

The `knit` package can be imported with `import("knit")`, and provides the following functions:

* `repl(in []string, patstr, repl string) ([]string, error)`: replace all
  occurrences of the Go regular expression `patstr` with `repl` within `in`.

* `extrepl(in []string, ext, repl string) []string`: replace all occurrences of the
  literal string `ext` as a suffix with `repl` within `in`.

* `glob(pat string) []string`: return all files in the current working
  directory that match the glob `pat`.

* `shell(cmd string) string`: execute a command with the shell and return its
  output. If the command exits with an error the returned output will be the
  contents of the error.

* `trim(s string) string`: trim leading and trailing whitespace from a string.

* `abs(path string) (string, error)`: return the absolute path of a path.

* `readfile(path string) string`: returns the contents of a file, or nil if it
  does not exist.

* `os`: a string containing the operating system name.

* `arch`: a string containing the machine architecture name.

# CLI and environment variables

Variables may be set at the command-line when invoking Knit with the syntax
`var=value`. These variables will be available in the Knitfile in the `cli`
table. Environment variables are similarly available in the `env` table.
